<p-toast></p-toast>
@if (isAdmin) {
@if (isLocked$ | async) {}@else{
<div class="mb-3">
  <button pButton label="הוסף מתנה" icon="pi pi-plus" class="p-button-success" (click)="openCreateDialog()">
  </button>
</div>
}}
  <!-- ✅ סינון לפי קטגוריה -->
    <div class="flex gap-2 align-items-center">
      <label class="font-semibold">סנן לפי קטגוריה:</label>
      <p-select
        [options]="categories"
        [(ngModel)]="selectedCategoryId"
        (onChange)="onCategoryChange($event.value)"
        optionLabel="name"
        optionValue="id"
        placeholder="כל הקטגוריות"
        [showClear]="true"
        [style]="{ minWidth: '200px' }">
      </p-select>
      <button
        *ngIf="selectedCategoryId"
        pButton
        icon="pi pi-times"
        class="p-button-rounded p-button-text"
        (click)="clearFilter()"
        pTooltip="נקה סינון">
      </button>
    </div>
<div class="surface-ground px-4 py-8 md:px-6 lg:px-8">
  <div class="grid">
    @for (product of filteredProducts; track product.id) {
    <div class="col-12 md:col-6 lg:col-3 p-3">
      <p-card styleClass="shadow-3 border-round h-full flex flex-column">

        <ng-template pTemplate="header">
          <div class="relative">
            <img [src]="product.imageUrl || 'assets/placeholder.png'" [alt]="product.title"
              class="w-full border-round-top" style="height: 220px; object-fit: cover;">

            <p-tag [severity]="product.isDrawn ? 'danger' : 'success'" [value]="product.isDrawn ? 'הוגרל' : 'פעיל'"
              class="absolute top-0 right-0 m-2">
            </p-tag>
          </div>
        </ng-template>

        <div class="flex flex-column gap-2" style="min-height: 150px;">
          <h2 class="text-xl font-bold text-900 m-0">{{ product.title }}</h2>

          <div class="flex flex-wrap gap-1">
            @for (cat of product.categories; track cat.id) {
            <p-tag [value]="cat.name" severity="info" [rounded]="true" styleClass="text-xs"></p-tag>
            }
          </div>

          <p class="text-600 line-height-3 m-0 overflow-hidden"
            style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
            {{ product.description }}
          </p>
        </div>

        <ng-template pTemplate="footer">
          <div class="border-top-1 surface-border pt-3">
            <div class="flex align-items-center justify-content-between mb-3">
              <span class="text-2xl font-bold text-primary">{{ product.price | currency:'ILS':'symbol':'1.0-0' }}</span>
              <!-- <span class="text-500 text-sm">קוד: {{ product.id }}</span> -->
            </div>

            <!-- <div class="flex gap-2">
              @if (!product.isDrawn) {
                <button pButton 
                        label="הוסף לסל" 
                        icon="pi pi-shopping-cart" 
                        class="w-full p-button-raised"
                        (click)="addToCart(product.id)">
                </button>
              } @else {
                <button pButton 
                        label="צפה בזוכה" 
                        icon="pi pi-trophy" 
                        class="w-full p-button-help p-button-outlined"
                        (click)="viewWinner(product.id)">
                </button>
              }
            </div> -->
            <div class="flex gap-2">

              @if (isAdmin) {
              @if (!product.isDrawn) {
              @if (isLocked$ | async) {
              <button pButton icon="pi pi-play" class="w-full p-button-success" (click)="runLottery(product.id)">
              </button>
              } @else {
              <button pButton icon="pi pi-pencil" class="w-full p-button-warning" (click)="updateGift(product)">
              </button>
              }
              } @else {
              <button pButton label="צפה בזוכה" icon="pi pi-trophy" class="w-full p-button-help"
                (click)="viewWinner(product.id)">
              </button>
              }
              }


              @else {
              @if (isLocked$ | async) {
              @if (!product.isDrawn) {
              <button pButton label="הוסף לסל" icon="pi pi-shopping-cart" class="w-full p-button-raised"
                (click)="addToCart(product.id)">
              </button>
              } @else {
              <button pButton label="צפה בזוכה" icon="pi pi-trophy" class="w-full p-button-help p-button-outlined"
                (click)="viewWinner(product.id)">
              </button>
              }
              } @else {
              <span class="text-orange-500 font-bold text-sm w-full text-center">
                המכירה טרם נפתחה
              </span>
              }
              }

            </div>

          </div>
        </ng-template>

      </p-card>
    </div>
    }
  </div>
</div>
<!-- <p-dialog header="עריכת מתנה" *ngIf="selectedProduct" [(visible)]="editDialog" [modal]="true" [style]="{width:'400px'}">

  <div class="flex flex-column gap-3">

    <input pInputText [(ngModel)]="selectedProduct.title" placeholder="שם מתנה">

    <input pInputText [(ngModel)]="selectedProduct.price" placeholder="מחיר">

    <input pInputText [(ngModel)]="selectedProduct.description" placeholder="תיאור">

  </div>

  <ng-template pTemplate="footer">

    <div class="flex justify-content-between w-full">

      <button pButton label="Delete" icon="pi pi-trash" class="p-button-danger" (click)="deleteGift()">
      </button>

      <button pButton label="Save" icon="pi pi-check" (click)="saveGift()">
      </button>

    </div>

  </ng-template>

</p-dialog> -->
<!-- 
<p-dialog header="הוספת מתנה חדשה"
          [(visible)]="createDialog"
          [modal]="true"
          [style]="{width:'400px'}">

  <div class="flex flex-column gap-3">

    <input pInputText [(ngModel)]="newProduct.title" placeholder="שם מתנה">

    <input pInputText type="number" [(ngModel)]="newProduct.price" placeholder="מחיר">

    <input pInputText [(ngModel)]="newProduct.description" placeholder="תיאור">

    <input pInputText [(ngModel)]="newProduct.imageUrl" placeholder="תמונה (URL)">

  </div>

  <ng-template pTemplate="footer">
    <button pButton
            label="שמירה"
            icon="pi pi-check"
            (click)="createGift()">
    </button>
  </ng-template>

</p-dialog> -->
<!-- דיאלוג עריכת מתנה -->
<p-dialog header="עריכת מתנה" [(visible)]="editDialog" [modal]="true" [style]="{width:'500px'}">

  <div class="flex flex-column gap-3">

    <!-- שם מתנה -->
    <div class="flex flex-column gap-2">
      <label for="edit-title" class="font-semibold">שם מתנה</label>
      <input id="edit-title" pInputText [(ngModel)]="selectedProduct.title" placeholder="הזן שם מתנה">
    </div>

    <!-- מחיר -->
    <div class="flex flex-column gap-2">
      <label for="edit-price" class="font-semibold">מחיר</label>
      <input id="edit-price" pInputText [(ngModel)]="selectedProduct.price" placeholder="הזן מחיר" type="number">
    </div>

    <!-- תיאור -->
    <div class="flex flex-column gap-2">
      <label for="edit-description" class="font-semibold">תיאור</label>
      <input id="edit-description" pInputText [(ngModel)]="selectedProduct.description" placeholder="הזן תיאור">
    </div>

    <!-- תורם -->
    <div class="flex flex-column gap-2">
      <label for="edit-donor" class="font-semibold">תורם</label>
      <p-select id="edit-donor" [options]="donors" [(ngModel)]="selectedProduct.donorId" optionLabel="userName"
        optionValue="id" placeholder="בחר תורם" [filter]="true" filterBy="userName" [showClear]="true"
        [style]="{ width: '100%' }">
      </p-select>
    </div>

    <!-- קטגוריות -->
    <div class="flex flex-column gap-2">
      <label for="edit-categories" class="font-semibold">קטגוריות</label>
      <p-multiSelect id="edit-categories" [options]="categories" [(ngModel)]="selectedProduct.categoryIds"
        optionLabel="name" optionValue="id" placeholder="בחר קטגוריות" [filter]="true" filterBy="name"
        [showClear]="true" display="chip" [style]="{ width: '100%' }">
      </p-multiSelect>
    </div>

    <!-- תמונה -->
    <div class="flex flex-column gap-2">
      <label for="edit-image" class="font-semibold">תמונה (URL)</label>
      <input id="edit-image" pInputText [(ngModel)]="selectedProduct.imageUrl" placeholder="הזן כתובת תמונה">
    </div>

  </div>

  <ng-template pTemplate="footer">
    <button pButton label="מחק" icon="pi pi-trash" class="p-button-danger p-button-text" (click)="deleteGift()">
    </button>
    <button pButton label="ביטול" icon="pi pi-times" class="p-button-text" (click)="editDialog = false">
    </button>
    <button pButton label="שמור" icon="pi pi-check" (click)="saveGift()">
    </button>
  </ng-template>

</p-dialog>
<!-- דיאלוג הוספת מתנה חדשה -->
<p-dialog header="הוספת מתנה חדשה" [(visible)]="createDialog" [modal]="true" [style]="{width:'500px'}">

  <div class="flex flex-column gap-3">

    <!-- שם מתנה -->
    <div class="flex flex-column gap-2">
      <label for="title" class="font-semibold">שם מתנה</label>
      <input id="title" pInputText [(ngModel)]="newProduct.title" placeholder="הזן שם מתנה">
    </div>

    <!-- מחיר -->
    <div class="flex flex-column gap-2">
      <label for="price" class="font-semibold">מחיר</label>
      <input id="price" pInputText [(ngModel)]="newProduct.price" placeholder="הזן מחיר" type="number">
    </div>

    <!-- תיאור -->
    <div class="flex flex-column gap-2">
      <label for="description" class="font-semibold">תיאור</label>
      <input id="description" pInputText [(ngModel)]="newProduct.description" placeholder="הזן תיאור">
    </div>

    <!-- תורם -->
    <div class="flex flex-column gap-2">
      <label for="donor" class="font-semibold">תורם</label>
      <p-select id="donor" [options]="donors" [(ngModel)]="newProduct.donorId" optionLabel="userName" optionValue="id"
        placeholder="בחר תורם" [filter]="true" filterBy="userName" [showClear]="true" [style]="{ width: '100%' }">
      </p-select>
    </div>

    <!-- קטגוריות -->
    <div class="flex flex-column gap-2">
      <label for="categories" class="font-semibold">קטגוריות</label>
      <p-multiSelect id="categories" [options]="categories" [(ngModel)]="newProduct.categoryIds" optionLabel="name"
        optionValue="id" placeholder="בחר קטגוריות" [filter]="true" filterBy="name" [showClear]="true" display="chip"
        [style]="{ width: '100%' }">
      </p-multiSelect>
    </div>

    <!-- תמונה -->
    <div class="flex flex-column gap-2">
      <label for="image" class="font-semibold">תמונה (URL)</label>
      <input id="image" pInputText [(ngModel)]="newProduct.imageUrl" placeholder="הזן כתובת תמונה">
    </div>

  </div>

  <ng-template pTemplate="footer">
    <button pButton label="ביטול" icon="pi pi-times" class="p-button-text" (click)="createDialog = false">
    </button>
    <button pButton label="שמירה" icon="pi pi-check" (click)="createGift()">
    </button>
  </ng-template>

</p-dialog>